
<!DOCTYPE html>
<html lang="en">
<head>

    <title>Filtered Me!</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


    <script src="js/jquery-3.1.0.js"></script>
    <link href="bootstrap.css" type="text/css" rel="stylesheet">

    <link href="narrow-jumbotron.css" type="text/css" rel="stylesheet">
    <script src="js/bootstrap.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/progressbar.js"></script>
    <script>
        
    
            function wsStart() {
                ws1 = new WebSocket("ws://localhost:8089/");
                ws1.onopen = function () {
                };
                ws1.onmessage = function (evt) {

                    try {
                        var json = jQuery.parseJSON(evt.data);
                      
                        var preview = document.querySelector('img');
                        preview.src = json['img'];
                        $("#sendBtn").prop('disabled', false);
                        $("#cancelBtn").prop('disabled', true);
                    }
                    catch (e) {
                        
                        if (evt.data == "error")
                        {
                            bar.set(0);
                            $("#sendBtn").prop('disabled', false);
                            $("#cancelBtn").prop('disabled', true);
                            alert("File is empty or too large");
                            return false;
                        }
                        
                        bar.animate(evt.data.replace(",", "."));
                       
                    }
                };
            }
            

            

         
            
      
        function previewFile() {
            var preview = document.querySelector('img');
            var reader = new FileReader();

            var file = document.querySelector('input[type=file]').files[0];

            if (file.size > 2 * 1024 * 1024)
            {
                alert("Too large file");
                return false;
            }

            reader.onloadend = function () {
                preview.style.border = "none";
                preview.src = reader.result;

            }
            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
            }
        }
        
        var bar;
        function sendImg() {
            var preview = document.querySelector('img');
            if (preview.src != "") {
                $("#sendBtn").prop('disabled', true);
                $("#cancelBtn").prop('disabled', false);
                bar.set(0);

                var AssocArray = {};
                AssocArray["filter"] = $("#filters").val();
                AssocArray["img"] = preview.src;
                var req = JSON.stringify(AssocArray);
                ws1.send(req);
            }
        }

        function cancel() {
           
            ws1.close();
                
                
            bar.set(0);
            $("#sendBtn").prop('disabled', false);
            $("#cancelBtn").prop('disabled', true);
               
            wsStart();
        }
       
        window.onload = function(){
            window.bar = new ProgressBar.Line('#container', { easing: 'easeInOut' });
            wsStart();  
        }
        
    </script>
    <style>
        #container {
       
          width: 100%;
          height: 30px;
        }
    </style>
</head>

<body>
     <input type="hidden" id="socketId" value="" />
    <div class="container">
        <div class="header clearfix">
            
            <h3 class="text-muted">Filtered Me!</h3>
        </div>

        <div class="jumbotron">
            <h1 class="display-3">Just upload</h1>
            <div id="container"></div>
           <div align ="center" >
            <img src="" height="200" alt="Image preview..."  style="border: 3px dashed #cccccc; display: block;">
            </div>
            <div style="margin-top: 20px;">
                <input type="file" onchange="previewFile();" style="display:inline-block;"/>
            
            
                <select id="filters" class="form-control" style="width:100px; display: inline-block; margin: 0;">
                    <option value="1">Invert</option>
                    <option value="2">Green</option>
                    <option value="3">BigPixels</option>
                </select>
                
                <div style="display:block;">
                    <div style="margin-top:20px;  display:block;">
                        <button class="btn btn-lg btn-success" id="sendBtn" style="text-decoration: none; color: white;" role="button" onclick="sendImg();">Upload</button>
                        <button class="btn btn-primary" disabled id="cancelBtn" style="text-decoration: none; color: white;" role="button" onclick="cancel();">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="console"></div>

        </div>

        

        <footer class="footer">
            <p>&copy; Shumilov Petr</p>
        </footer>

    </div>
</body>
</html>
