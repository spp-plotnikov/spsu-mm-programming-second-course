<!DOCTYPE html>
<html lang="en">
<head>
    <title>Filters</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <style>
        body * {
            font-size: 20px;
        }

        button {
            cursor: pointer;
        }

        button:active {
            box-shadow:inset 0 0 7px black;
        }

        .images-progressbar-cont {
            width: 800px;
            background: #f9f9f9;
        }


        .images-box {
            text-align: center;   
            height: 350px;
            border: 1px solid #eee;
            
        }

        .images-box > img {
            height: auto;
            width: auto;
            max-width: 350px;
            max-height: 300px;
            padding: 20px;
            cursor: pointer;
        }

        #before-img {
            float: left;
        }

        #after-img {
            float: right;
        }

        #text-status {
            color: #949292;
            font-size: 17px;
            height: 20px;
            text-align: center;
        }

        #progressCont {            
            margin-bottom: 10px;
            background: #eee;
        }

        #progress {
            height: 20px;
            background: blue;
            width: 0%;
        }

        #send {
            padding: 10px;
            background: green;
            color: #fff;
            border: 1px solid #094611;
        }

        #cancel {
            color: #fff;
            padding: 10px;
            background: red;
            border: 1px solid #ca2424;
        }
    </style>
</head>
<body>
    
    <div class="images-progressbar-cont">
        <div class="images-box">
            <img id="before-img">
            <img id="after-img">
        </div>
        <div id="text-status"></div>
        <div id="progressCont">
            <div id="progress"></div>
        </div>
    </div>
    <input id="file-input" type="file" accept="image/*">
    <p>
        Filter:
        <select id="filters">
            {{$filters}}
        </select>
    </p>    
    <button id="send">Send</button>
    <button id="cancel">Cancel</button>


    <script>
        function FiltersApp(opts) {
            this.opts = opts;
            this.init();
        }

        FiltersApp.prototype = {
            MAX_FILE_SIZE: 10 * 1024 * 1024,

            init: function() {
                this.initWebSocket();
                this.initDOMEvents();
                this.isImageOpened = false;                
            },
            initWebSocket: function() {
                this.ws = new WebSocket('ws://127.0.0.1:8081/');
                var self = this,
                    ws = this.ws;

                this.ws.onopen = function() {
                    console.log('Connection is opened!');
                    ws.send(JSON.stringify({
                        commandType: 0, // 0 stands for "Greeting" 
                        greeting: 'Hello, Server!'
                    }));
                };

                this.ws.onmessage = function (event) {
                    self.handleMessage(JSON.parse(event.data));

                };

                this.ws.onclose = function() {
                    console.log('Connection is closed!');
                    setTimeout(function() {
                        self.initWebSocket();
                    }, 5000); //trying to reopen                    
                };

                this.ws.onerror = function(err) {
                    console.log('Error: ' + err);
                };

            },            
            initDOMEvents: function() {
                var self = this;

                $(this.opts.sendBttn).click(function() {
                    if (!self.isImageOpened) {
                        return;
                    }
 
                    var sourceImg = $(self.opts.beforeImg).attr('src'),
                        imgInBase64 = sourceImg,
                        filter = parseInt($(self.opts.filtersSelect).val());                    

                    $(self.opts.textStatus).text('Sending image...');
                    
                    self.ws.send(JSON.stringify({
                        commandType: 1, // 1 stands for "Process image" 
                        filter: filter,
                        imgB64: imgInBase64
                    }));   
                });

                $(this.opts.cancelBttn).click(function() {
                    $(self.opts.textStatus).text('Cancelling...');
                    
                    self.ws.send(JSON.stringify({
                        commandType: 2, // 2 stands for "Send cancel" 
                    }));
                });

                $(this.opts.fileInput).change(function() {
                    if (self.isFileSelected(this)) {
                        if (this.files[0].size > self.MAX_FILE_SIZE) {
                            $(self.opts.textStatus).text('Max file size is 10Mb, your file size is bigger :(');
                            this.value = "";
                            return;
                        } else {
                            $(self.opts.textStatus).empty();
                        }

                        $(self.opts.textStatus).text('Opening image...');
                        
                        var fr = new FileReader();                        
                        self.isImageOpened = false;
                        
                        fr.onload = function(e) {
                            $(self.opts.textStatus).text('Image has been opened');
                            self.isImageOpened = true;
                            $(self.opts.beforeImg).attr('src', e.target.result)
                        }
                        
                        fr.readAsDataURL(this.files[0]);
                    }
                })

                var imgClick = function() {
                    var win = window.open(this.src, '_blank');
                    win.focus();
                }

                $(this.opts.beforeImg).click(imgClick);
                $(this.opts.afterImg).click(imgClick)

                
            },
            isFileSelected(input) {
                return input.files && input.files[0];
            },
            
            handleMessage: function(msg) {
                switch (msg.commandType) {
                    case 0:
                        console.log("Greeting: " + msg.greeting);
                        break;
                    case 1:
                        this.handleSendResult(msg);
                        break;
                    case 2:
                        this.handleCancelResult(msg);
                        break;
                }
            },
            receiveFiltered: function(imgB64) {
                $(this.opts.textStatus).text('Image has been received');
                $(this.opts.afterImg).attr('src', imgB64);

                $(this.opts.progress).animate({
                    opacity: 0
                }, 1200, function() {
                    $(this).css({
                        width: 0,
                        opacity: 1
                    })
                });
            },
            updateProgress: function(progress) {
                $(this.opts.progress).animate({
                    width: progress + '%'
                }, 100);
            },
            handleCancelResult: function(msg) {
                switch (msg.status) {
                    case 0:
                        $(this.opts.textStatus).text('Cancelling failed!');
                        break;
                    case 1:
                        $(this.opts.textStatus).text('Successfully cancelled!');
                        break;
                    case 2:
                        $(this.opts.textStatus).text('Nothing to cancel, sorry :(');
                        break;
                }

                $(this.opts.progress).animate({
                    opacity: 0
                }, 1200, function() {
                    $(this).css({
                        width: 0,
                        opacity: 1
                    })
                });                
            },
            handleSendResult: function(msg) {
                switch (msg.status) {
                    case 0:
                        $(this.opts.textStatus).text('Sending failed!');
                        break;
                    case 1:
                        $(this.opts.textStatus).text('Successfully sended! Server is doing its job now...');
                        break;
                    case 2:
                        this.updateProgress(msg.progress);
                        break;
                    case 3:
                        $(this.opts.textStatus).text('Filtered on server. Receiving image...');
                        break;
                    case 4:
                        this.receiveFiltered(msg.imgB64);
                        break;
                    case 5:
                        $(this.opts.textStatus).text('Something went wrong...');
                        break;
                    case 6:
                        $(this.opts.textStatus).text('You are filtering image now. Cancel if you want to filter another image now...');
                        break;
                }
            }
        }

        $(document).ready(function() {
            var app = new FiltersApp({
                fileInput: '#file-input',
                progress: '#progress',
                progressCont: '#progressCont',
                filtersSelect: '#filters',
                sendBttn: '#send',
                cancelBttn: '#cancel',
                beforeImg: '#before-img',
                afterImg: '#after-img',
                textStatus: '#text-status'
            });
        });
    </script>
</body>
</html>
